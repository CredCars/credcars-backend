name: CI/CD NestJS â†’ Elastic Beanstalk

on:
  push:
    branches:
      - staging
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      MONGODB_URI: ${{ vars.MONGODB_URI }}
      JWT_SECRET: ${{ vars.JWT_SECRET }}
      JWT_REFRESH_SECRET: ${{ vars.JWT_REFRESH_SECRET }}
      JWT_EXPIRES_IN: ${{ vars.JWT_EXPIRES_IN }}
      JWT_REFRESH_EXPIRES_IN: ${{ vars.JWT_REFRESH_EXPIRES_IN }}
      NODE_ENV: test
      ALLOWED_ORIGINS: ${{ vars.ALLOWED_ORIGINS }}
      FRONTEND_URL: ${{ vars.FRONTEND_URL }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Cache node modules
        uses: actions/cache@v3
        with:
          # Key should change if package-lock.json changes
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          # Restores cache if key exists
          path: ~/.npm

      - run: npm ci
      - run: npm run lint
      - run: npm test -- --coverage
      - run: npm run build

      - name: Package for Elastic Beanstalk
        run: |
          zip -r app.zip dist package.json package-lock.json Procfile .ebextensions -x "*.git*" || true
          unzip -l app.zip | head -20

      - uses: actions/upload-artifact@v4
        with:
          name: eb-artifact
          path: app.zip

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-test
    environment: ${{ github.ref_name == 'main' && 'production' || 'staging' &&'staging' }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: eb-artifact
          path: .

      - uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ vars.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ vars.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7

      # Determine environment from branch
      - name: Set environment variables
        run: |
          if [[ "${GITHUB_REF##*/}" == "main" ]]; then
            ENV="production"
            EB_ENV="Credcars-backend-production-env"
            EB_GREEN_ENV="Credcars-backend-production-green-env"
          else
            ENV="staging"
            EB_ENV="Credcars-backend-staging-env"

          fi
          echo "ENV=$ENV" >> $GITHUB_ENV
          echo "EB_ENV=$EB_ENV" >> $GITHUB_ENV
          echo "EB_GREEN_ENV=$EB_GREEN_ENV" >> $GITHUB_ENV
          echo "TERRAFORM_DIR=infra/terraform/$ENV" >> $GITHUB_ENV

      # Move app.zip to the correct environment folder
      - name: Move app.zip to Terraform environment directory
        run: |
          mkdir -p $TERRAFORM_DIR
          mv app.zip "$TERRAFORM_DIR/app-${ENV}.zip"

      - name: Create $ENV.tfvars from environment variables
        run: |
          cd $TERRAFORM_DIR
          cat > $ENV.tfvars <<EOF
          database_url = "${MONGODB_URI}"
          jwt_secret = "${JWT_SECRET}"
          jwt_refresh_secret = "${JWT_REFRESH_SECRET}"
          jwt_expires_in = "${JWT_EXPIRES_IN}"
          jwt_refresh_expires_in = "${JWT_REFRESH_EXPIRES_IN}"
          allowed_origins = "${ALLOWED_ORIGINS}"
          frontend_url = "${FRONTEND_URL}"
          env = "${NODE_ENV}"
          EOF
          echo "âœ… $ENV.tfvars created successfully"

      # âœ… Initialize and apply Terraform's configuration
      - name: Terraform init
        run: |
          cd $TERRAFORM_DIR
          terraform init -reconfigure

      - name: Terraform apply (staging/production)
        run: |
          cd $TERRAFORM_DIR
          terraform apply -auto-approve -target=aws_iam_user.github_deployer -target=aws_iam_user_policy.github_deployer_policy -var-file="$ENV.tfvars"

      - name: Deploy to Elastic Beanstalk
        run: |
          VERSION_LABEL="v-${GITHUB_RUN_NUMBER}-$ENV"
          # Upload app.zip to S3
          aws s3 cp "$TERRAFORM_DIR/app-${ENV}.zip" s3://elasticbeanstalk-${{ vars.AWS_REGION }}-${{ vars.AWS_ACCOUNT_ID }}/app-${ENV}.zip

          # Create new EB version
          aws elasticbeanstalk create-application-version \
            --application-name Credcars-backend \
            --version-label $VERSION_LABEL \
            --source-bundle S3Bucket="elasticbeanstalk-${{ vars.AWS_REGION }}-${{ vars.AWS_ACCOUNT_ID }}",S3Key="app-${ENV}.zip"

          # Deploy to Environment
          if [ "$ENV" = "production" ]; then
            echo "Deploying to GREEN environment first..."
            # Deploy to GREEN
            aws elasticbeanstalk update-environment \
              --application-name Credcars-backend \
              --environment-name $EB_GREEN_ENV \
              --version-label $VERSION_LABEL

            echo "â³ Waiting for GREEN environment to be healthy..."
            for i in {1..60}; do
              STATUS=$(aws elasticbeanstalk describe-environments \
                --environment-names $EB_GREEN_ENV \
                --query "Environments[0].Status" --output text)
              HEALTH=$(aws elasticbeanstalk describe-environments \
                --environment-names $EB_GREEN_ENV \
                --query "Environments[0].Health" --output text)

              echo "Status: $STATUS | Health: $HEALTH"
              if [ "$STATUS" == "Ready" ] && [ "$HEALTH" == "Green" ]; then
                echo "âœ… GREEN environment is ready and healthy!"
                break
              fi
              sleep 20
            done

            # Swap only if healthy
            if [ "$STATUS" == "Ready" ] && [ "$HEALTH" == "Green" ]; then
              echo "ðŸ” Swapping BLUE (live) and GREEN (new) environments..."
              aws elasticbeanstalk swap-environment-cnames \
                --source-environment-name $EB_ENV \
                --destination-environment-name $EB_GREEN_ENV
              echo "âœ… Swap complete. GREEN is now live."

              # âœ… Post-deployment quick health verification
              echo "ðŸ” Verifying post-swap health..."
              POST_HEALTH=$(aws elasticbeanstalk describe-environments \
                --environment-names $EB_GREEN_ENV \
                --query "Environments[0].Health" \
                --output text)

              if [ "$POST_HEALTH" == "Green" ]; then
                echo "âœ… Deployment successful! Environment is healthy."
              else
                echo "âŒ Post-deployment health is $POST_HEALTH. Rolling back..."
                aws elasticbeanstalk swap-environment-cnames \
                  --source-environment-name $EB_GREEN_ENV \
                  --destination-environment-name $EB_ENV
                echo "ðŸ”„ Rolled back to BLUE environment."
                exit 1
              fi

            else
              echo "âŒ Deployment failed. GREEN environment not healthy. No swap performed."
              exit 1
            fi

          else
            echo "ðŸ§ª Deploying to STAGING environment..."
            aws elasticbeanstalk update-environment \
              --application-name Credcars-backend \
              --environment-name $EB_ENV \
              --version-label $VERSION_LABEL
          fi

      # âœ… Clean up old EB versions (keep last 5)
      - name: Clean up old application versions
        run: |
          echo "ðŸ§¹ Cleaning up old application versions (keeping last 5)..."
          OLD_VERSIONS=$(aws elasticbeanstalk describe-application-versions \
            --application-name Credcars-backend \
            --query "ApplicationVersions[?Status=='Processed'] | sort_by(@, &DateCreated)[:-5].VersionLabel" \
            --output text)

          if [ -n "$OLD_VERSIONS" ]; then
            for VERSION in $OLD_VERSIONS; do
              echo "ðŸ—‘ï¸ Deleting old version: $VERSION"
              aws elasticbeanstalk delete-application-version \
                --application-name Credcars-backend \
                --version-label $VERSION \
                --delete-source-bundle
            done
          else
            echo "âœ… No old versions to delete."
          fi
