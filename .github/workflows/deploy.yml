name: Deploy CredCars Backend

# Trigger workflow on push to main AND manually
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Set up SSH
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.8.1
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      # 3. Connect to your server and deploy
      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@54.235.43.222 << 'EOF'
            set -e

            cd /home/ubuntu/credcars-backend
            git pull origin main

            # Build new image
            docker-compose build

            # Start new container in background
            docker-compose up -d --no-deps --build backend_new

            # Wait for healthcheck
            for i in {1..12}; do
              STATUS=$(docker inspect --format='{{.State.Health.Status}}' credcars-backend_new)
              if [ "$STATUS" == "healthy" ]; then
                echo "New container healthy, swapping..."
                docker stop credcars-backend || true
                docker rename credcars-backend_new credcars-backend
                exit 0
              fi
              sleep 5
            done

            echo "New container failed health check. Rolling back..."
            docker stop credcars-backend_new
            exit 1
          EOF
