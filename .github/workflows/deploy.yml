# name: Deploy CredCars Backend (Production)

# on:
#   push:
#     branches:
#       - main
#   workflow_dispatch:

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       # 1️⃣ Checkout the code
#       - name: Checkout code
#         uses: actions/checkout@v3

#       # 2️⃣ Set up Node.js
#       - name: Set up Node.js
#         uses: actions/setup-node@v3
#         with:
#           node-version: 20

#       # 3️⃣ Install dependencies
#       - name: Install Backend Dependencies
#         run: |
#           echo "=== Installing Backend Dependencies ==="
#           npm ci --unsafe-perm --no-audit --no-fund
#           echo "✅ Dependencies installed successfully!"

#       # 4️⃣ Run tests (if any)
#       - name: Run Backend Tests
#         run: |
#           echo "=== Running Backend Tests ==="
#           npm run test --if-present
#           echo "✅ Backend tests passed! "

#       # 5️⃣ Log in to Docker Hub
#       - name: Log in to Docker Hub
#         uses: docker/login-action@v2
#         with:
#           username: ${{ secrets.DOCKER_USERNAME }}
#           password: ${{ secrets.DOCKER_PASSWORD }}

#       # 6️⃣ Build & push Docker image
#       - name: Build and Push Backend Image
#         run: |
#           echo "=== Building Backend Docker Image ==="
#           docker build -t ${{ secrets.DOCKER_USERNAME }}/credcars-backend:latest .
#           docker push ${{ secrets.DOCKER_USERNAME }}/credcars-backend:latest
#           echo "✅ Backend image pushed to Docker Hub!"

#       # 7️⃣ Deploy on your server
#       - name: Deploy Backend to Server
#         uses: appleboy/ssh-action@master
#         with:
#           host: ${{ secrets.SERVER_HOST }}
#           username: ubuntu
#           key: ${{ secrets.SERVER_SSH_KEY }}
#           port: 22
#           timeout: 120s
#           command_timeout: 60s
#           script: |
#             set -e
#             echo "=== Deploying Backend ==="

#             # Navigate to backend folder
#             cd /home/ubuntu/credcars-backend || true

#             # Stop and remove any old container
#             docker stop credcars-backend || true
#             docker rm credcars-backend || true

#             # Pull the latest image from Docker Hub
#             echo "Pulling latest image..."
#             docker pull ${{ secrets.DOCKER_USERNAME }}/credcars-backend:latest

#             # Start new container with .env
#             echo "Starting new backend container..."
#             docker run -d --name credcars-backend -p 3000:3000 \
#               --env-file /home/ubuntu/credcars-backend/.env \
#               -e NODE_ENV=production \
# ${{ secrets.DOCKER_USERNAME }}/credcars-backend:latest

#             sleep 5
#             echo "✅ Backend deployed successfully!"
